define(["jquery","core/log","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events"],function(l,d,u,p,h,i,e){"use strict";function t(e){var t=this;t.rootel=e,t.component="local_announcements",t.ver=t.component+"_2019102301",t.selectedtabcode="",t.intersectionjson="",t.modals={VIEWUSERS:null},t.templates={VIEWUSERS:"local_announcements/announcement_users_list"},t.strings={},h.get_strings([{key:"audienceselector:continueintersection",component:t.component},{key:"audienceselector:createintersection",component:t.component}]).then(function(e){t.strings.continueintersection=e[0],t.strings.createintersection=e[1]})}return t.prototype.main=function(){var n,a=this;a.renderTags(),a.rootel.find(".audience-tab").on("click",function(e){e.preventDefault();var t=l(this);a.openTab(t)}),a.rootel.on("click",".audience-add-btn",function(e){e.preventDefault();var t=l(this);a.addTag(t)}),a.rootel.on("click",".remove-tag",function(e){e.preventDefault();var t=l(this);a.removeTag(t)}),a.rootel.on("click",".audience-intersect-btn",function(e){e.preventDefault();var t=l(this);a.addIntersection(t)}),a.rootel.on("click",".intersection-finish-btn",function(e){e.preventDefault(),a.finishIntersection()}),a.rootel.on("click",".intersection-cancel-btn",function(e){e.preventDefault(),a.clearIntersectionWorkspace()}),a.rootel.on("click",".rule-toggle",function(e){e.preventDefault();var t=l(this);a.showModerationRule(t)}),a.rootel.on("keyup",".audience-filter",function(e){clearTimeout(n);var t=l(this);n=setTimeout(function(){a.handleFitlerChange(t)},500)}),a.rootel.on("change","input:checkbox",function(e){var t=l(this);a.handleItemChange(t)}),a.rootel.on("click","#action-viewusers",function(e){e.preventDefault(),a.getUserList()}),a.checkForOriginCourse();var e=[];e.push(a.loadModal("VIEWUSERS","Preview recipients","",i.types.DEFAULT)),e.push(a.loadTemplate("VIEWUSERS")),l.when.apply(l,e).then(function(){a.rootel.addClass("preloads-completed")})},t.prototype.openTab=function(e,t){var n=this,a=e.data("audiencetype"),o=n.rootel.find('.contents[data-audiencetype="'+a+'"]').first(),i=o.hasClass("loaded"),s=o.parent().hasClass("loading")&&n.selectedtabcode==a;i||s||(n.selectedtabcode=a,n.getAudienceItems(e,o,t),o.parent().addClass("loading")),n.rootel.find(".contents").removeClass("selected"),o.addClass("selected")},t.prototype.getAudienceItems=function(e,a,o){var i=this,t=e.data("audiencetype"),s=a.data("audiencenamesingular"),r=a.data("audiencenameplural"),c=a.find(".items").first();u.call([{methodname:"local_announcements_get_audience_items",args:{type:t},done:function(n){var e="local_announcements/audience_list";if(n.grouped)e="local_announcements/audience_list_tree";p.render(e,n,i.ver).then(function(e){if(n.audiencelist.length||n.audiencelistgrouped.length)c.html(e),o&&(d.debug("Preselecting: "+o),a.find('.item[value="'+o+'"]').first().prop("checked",!0)),n.grouped&&i.initialiseTreeView(a),10<n.audiencelist.length&&a.find(".list").addClass("list-gt10"),a.parent().removeClass("loading"),a.addClass("loaded");else{var t=h.get_string("audienceselector:noaudienceitems","local_announcements",n.typenameplural);l.when(t).done(function(e){i.handleNoItems(a,n,"local_announcements/audienceselector: User is not a member of any "+r+".",e)})}}).fail(function(e){i.handleNoItems(a,e,"local_announcements/audienceselector: Failed to render audience items.","Failed to get "+s+" associations.")})},fail:function(e){i.handleNoItems(a,e,"local_announcements/audienceselector: Failed to get audience items","Failed to get "+s+" associations.")}}])},t.prototype.getUserList=function(){var n=this,e=l('input[name="audiencesjson"]').val();n.modals.VIEWUSERS&&(n.modals.VIEWUSERS.getModal().addClass("modal-xl"),n.modals.VIEWUSERS.setBody('<div style="font-style:italic;">... Fetching user list ...<div class="loader" style="display:block;"><div class="circle spin"></div></div></div>'),n.modals.VIEWUSERS.show(),u.call([{methodname:"local_announcements_get_audienceselector_users",args:{audiencesjson:e},done:function(e){var t=Object.keys(e.userslist).length;p.render(n.templates.VIEWUSERS,e,n.ver).done(function(e){e="<p><strong>The following "+t+" user(s) will receive this announcement</strong></p>"+e,n.modals.VIEWUSERS.setBody(e)}).fail(function(e){return d.debug(e),"Failed to render announcement user list."})},fail:function(e){d.error("local_announcements/audienceselector: unable to get announcemnt users."),d.debug(e)}}]))},t.prototype.initialiseTreeView=function(e){e.find(".group-name").on("click",function(e){var t=l(this);t.parent().find(".group-items").toggleClass("active"),t.toggleClass("caret-down")})},t.prototype.handleNoItems=function(e,t,n,a){var o=e.find(".items").first();d.debug(n),e.parent().removeClass("loading"),e.addClass("no-items"),o.html(a)},t.prototype.renderTags=function(){var e,t=l('input[name="audiencesjson"]').val(),n=new Array;if(t)for(n=JSON.parse(t),e=0;e<n.length;++e)this.renderTag(n[e]);this.handleTagChanges()},t.prototype.addTag=function(e){var t=e.closest(".contents"),n=this.getSelected(t);if(n){var a=new Array,o=l('input[name="audiencesjson"]');o.val()&&(a=JSON.parse(o.val()));var i={type:"union",uid:Date.now(),audiences:[n]};a.push(i);var s=JSON.stringify(a);o.val(s),this.renderTag(i),this.closeAudienceSelector(t),this.handleTagChanges()}},t.prototype.closeAudienceSelector=function(e){e.removeClass("selected"),e.find(".items input").prop("checked",!1),e.find(".roles input").prop("checked",!1),e.find(".buttons").removeClass("show"),e.hasClass("contents-filterable")&&(e.find(".audience-filter").val(""),e.find(".list li").removeClass("active"))},t.prototype.addIntersection=function(e){var n=this,t=e.closest(".contents"),a=n.getSelectedSplit(t);if(a.length){var o=new Array;n.intersectionjson&&(o=JSON.parse(n.intersectionjson)),l.each(a,function(e,t){o.push(t)}),n.intersectionjson=JSON.stringify(o),l.each(a,function(e,t){n.renderIntersection(t)}),1<o.length&&n.rootel.find(".intersection-workspace").addClass("has-multiple-tags"),n.rootel.find(".audience-intersect-btn").html(n.strings.continueintersection),n.rootel.find(".audience-add-btn").hide(),n.rootel.find(".audience-tab").hide(),n.rootel.find(".audience-tab.contents-intersectable").show(),n.closeAudienceSelector(t)}},t.prototype.finishIntersection=function(e){var t=JSON.parse(this.intersectionjson);if(!(t.length<2)){var n=new Array,a=l('input[name="audiencesjson"]');a.val()&&(n=JSON.parse(a.val()));var o={type:"intersection",uid:Date.now(),audiences:t};n.push(o);var i=JSON.stringify(n);a.val(i),this.renderTag(o),this.clearIntersectionWorkspace(),this.handleTagChanges()}},t.prototype.clearIntersectionWorkspace=function(){var e=this;e.intersectionjson="",e.rootel.find(".audience-add-btn").show(),e.rootel.find(".audience-intersect-btn").html(e.strings.createintersection),e.rootel.find(".audience-tab").show(),e.rootel.find(".intersection-workspace").removeClass("has-tags"),e.rootel.find(".intersection-workspace").removeClass("has-multiple-tags"),e.rootel.find(".intersection-tags-list .box").fadeOut(300,function(){l(this).remove()})},t.prototype.getSelected=function(e){var t=e.data("audienceprovider"),n=e.data("audiencetype"),a=e.data("audiencenamesingular"),o=e.data("audiencenameplural"),i=e.data("audiencehasroles"),s=new Array;if(e.find(".item:checked").each(function(){var e=l(this),t={code:e.val(),name:e.data("name")};s.push(t)}),s.length){if(i){var r=new Array;if(e.find(".role:checked").each(function(){var e=l(this),t={code:e.val(),name:e.data("name")};r.push(t)}),!r.length)return}return{audienceprovider:t,audiencetype:n,audiencenamesingular:a,audiencenameplural:o,selecteditems:s,selectedroles:r}}},t.prototype.getSelectedSplit=function(e){var o=this.getSelected(e),i=new Array;return l.each(o.selecteditems,function(e,t){var n=new Array;n.push(t);var a={audienceprovider:o.audienceprovider,audiencetype:o.audiencetype,audiencenamesingular:o.audiencenamesingular,audiencenameplural:o.audiencenameplural,selecteditems:n,selectedroles:o.selectedroles};i.push(a)}),i},t.prototype.removeTag=function(e){var t,n=e.data("taguid"),a=l('input[name="audiencesjson"]'),o=JSON.parse(a.val()),i=new Array;for(t=0;t<o.length;t++){o[t].uid!=n&&i.push(o[t])}var s="";i.length&&(s=JSON.stringify(i)),a.val(s),e.parent().parent().fadeOut(300,function(){l(this).remove()}),this.handleTagChanges()},t.prototype.renderTag=function(e){var t=this,n=t.rootel.find(".tags .loader");n.addClass("show"),p.render("local_announcements/audience_tag",e,t.ver).then(function(e){t.rootel.find(".tags-list").append(e),n.removeClass("show")}).fail(function(e){d.error(e)})},t.prototype.renderIntersection=function(e){var t=this,n=t.rootel.find(".intersection-workspace .loader");n.addClass("show"),p.render("local_announcements/intersection_tag",e,t.ver).then(function(e){t.rootel.find(".intersection-tags-list").append(e),t.rootel.find(".intersection-workspace").addClass("has-tags"),n.removeClass("show")}).fail(function(e){d.error(e)})},t.prototype.handleFitlerChange=function(e){var t=e.parent().find(".list").first();t.find(".more").remove(),t.find("li").removeClass("active");var n=e.val().toLowerCase();if(0==n.length)return!1;var a=0;t.find("li").each(function(){if(name=l(this).find("input").first().data("name").toLowerCase(),0<=name.indexOf(n)){if(50<++a)return t.append(l("<li/>").addClass("more-items active").text("More records are available. be more specific to narrow this down.")),!1;l(this).addClass("active")}})},t.prototype.handleItemChange=function(e){var t=e.closest(".contents"),n=t.data("audiencetype"),a="#contents-"+n,o=a+" .buttons",i=t.data("audiencehasroles"),s=e.closest("."+n+"-item");e.prop("checked")?s.addClass("selected"):s.removeClass("selected"),l(o).removeClass("show"),0<l(a+" .items input:checkbox:checked").length&&(i?0<l(a+" .roles input:checkbox:checked").length&&l(o).addClass("show"):l(o).addClass("show"))},t.prototype.checkForOriginCourse=function(){var e=this.getUrlParameter("type"),t=this.getUrlParameter("code");if(void 0!==e&&void 0!==t){var n=l("[data-audiencetype="+e+"]");this.openTab(n,t)}},t.prototype.getUrlParameter=function(e){var t,n,a=window.location.search.substring(1).split("&");for(n=0;n<a.length;n++)if((t=a[n].split("="))[0]===e)return void 0===t[1]||decodeURIComponent(t[1])},t.prototype.handleTagChanges=function(){this.checkModerationStatus();var e=new Array,t=l('input[name="audiencesjson"]');t.val()&&(e=JSON.parse(t.val())),e.length?this.rootel.addClass("has-tags"):this.rootel.removeClass("has-tags")},t.prototype.checkModerationStatus=function(){var t=l(".moderation-status"),n=l(".moderation-status .status"),a=l(".moderation-status .description");l(".moderation-status .ajax");a.removeClass("active"),t.removeClass("visible hasmod");var e=l('input[name="audiencesjson"]').val();0!=e.length&&(t.addClass("visible loading"),u.call([{methodname:"local_announcements_get_moderation_for_audiences",args:{audiencesjson:e},done:function(e){setTimeout(function(){e.required?(n.html(e.status+' <a class="rule-toggle" href="#">More</a>'),a.html(e.description),t.removeClass("loading").addClass("hasmod")):t.removeClass("loading").removeClass("visible")},1e3)},fail:function(e){t.removeClass("visible loading"),d.debug(e)}}]))},t.prototype.checkCCGroups=function(){},t.prototype.showModerationRule=function(e){e.closest(".moderation-status").find(".description").first().addClass("active"),e.remove()},t.prototype.loadModal=function(t,n,a,e){var o=this;return i.create({type:e}).then(function(e){e.setTitle(n),a&&e.setSaveButtonText(a),(o.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},t.prototype.loadTemplate=function(e){return p.render(this.templates[e],{},this.ver)},{init:function(){d.debug("local_announcements/audienceselector: initializing the audience-selector component");var e=l(".audience-selector").first();e.length?new t(e).main():d.error("local_announcements/audienceselector: audience-selector root element not found!")}}});