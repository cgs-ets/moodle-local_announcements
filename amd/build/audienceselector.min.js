define(["jquery","core/log","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events"],function(c,d,u,p,m,i,e){"use strict";function n(e){var n=this;n.rootel=e,n.component="local_announcements",n.selectedtabcode="",n.intersectionjson="",n.modals={VIEWUSERS:null},n.templates={VIEWUSERS:"local_announcements/announcement_users_list"},n.strings={},m.get_strings([{key:"audienceselector:continueintersection",component:n.component},{key:"audienceselector:createintersection",component:n.component}]).then(function(e){n.strings.continueintersection=e[0],n.strings.createintersection=e[1]})}return n.prototype.main=function(){var t,a=this;a.renderTags(),a.rootel.find(".audience-tab").on("click",function(e){e.preventDefault();var n=c(this);a.openTab(n)}),a.rootel.on("click",".audience-add-btn",function(e){e.preventDefault();var n=c(this);a.addTag(n)}),a.rootel.on("click",".remove-tag",function(e){e.preventDefault();var n=c(this);a.removeTag(n)}),a.rootel.on("click",".audience-intersect-btn",function(e){e.preventDefault();var n=c(this);a.addIntersection(n)}),a.rootel.on("click",".intersection-finish-btn",function(e){e.preventDefault(),a.finishIntersection()}),a.rootel.on("click",".intersection-cancel-btn",function(e){e.preventDefault(),a.clearIntersectionWorkspace()}),a.rootel.on("click",".rule-toggle",function(e){e.preventDefault();var n=c(this);a.showModerationRule(n)}),a.rootel.on("keyup",".audience-filter",function(e){clearTimeout(t);var n=c(this);t=setTimeout(function(){a.handleFitlerChange(n)},500)}),a.rootel.on("change","input:checkbox",function(e){var n=c(this);a.handleItemChange(n)}),a.rootel.on("click","#action-viewusers",function(e){e.preventDefault(),a.getUserList()}),a.checkForOriginCourse();var e=[];e.push(a.loadModal("VIEWUSERS","Preview recipients","",i.types.DEFAULT)),e.push(a.loadTemplate("VIEWUSERS")),c.when.apply(c,e).then(function(){a.rootel.addClass("preloads-completed")})},n.prototype.openTab=function(e,n){var t=this,a=e.data("audiencetype"),o=t.rootel.find('.contents[data-audiencetype="'+a+'"]').first(),i=o.hasClass("loaded"),s=o.parent().hasClass("loading")&&t.selectedtabcode==a;i||s||(t.selectedtabcode=a,t.getAudienceItems(e,o,n),o.parent().addClass("loading")),t.rootel.find(".contents").removeClass("selected"),o.addClass("selected")},n.prototype.getAudienceItems=function(e,o,i){var s=this,n=e.data("audiencetype"),t=o.data("audiencenamesingular"),r=o.data("audiencenameplural"),l=o.find(".items").first();u.call([{methodname:"local_announcements_get_audience_items",args:{type:n},done:function(a){var e="local_announcements/audience_list";if(a.grouped)e="local_announcements/audience_list_tree";p.render(e,a).then(function(e){if(a.audiencelist.length||a.audiencelistgrouped.length){if(l.html(e),i){d.debug("Preselecting: "+i);var n=o.find('.item[value="'+i+'"]').first();n.prop("checked",!0),s.handleItemChange(n)}a.grouped&&s.initialiseTreeView(o),10<a.audiencelist.length&&o.find(".list").addClass("list-gt10"),o.parent().removeClass("loading"),o.addClass("loaded")}else{var t=m.get_string("audienceselector:noaudienceitems","local_announcements",a.typenameplural);c.when(t).done(function(e){s.handleNoItems(o,a,"local_announcements/audienceselector: User is not a member of any "+r+".",e)})}}).fail(function(e){s.handleNoItems(o,e,"local_announcements/audienceselector: Failed to render audience items.","Failed to get "+t+" associations.")})},fail:function(e){s.handleNoItems(o,e,"local_announcements/audienceselector: Failed to get audience items","Failed to get "+t+" associations.")}}])},n.prototype.getUserList=function(){var t=this,e=c('input[name="audiencesjson"]').val();t.modals.VIEWUSERS&&(t.modals.VIEWUSERS.getModal().addClass("modal-xl"),t.modals.VIEWUSERS.setBody('<div style="font-style:italic;">... Fetching user list ...<div class="loader" style="display:block;"><div class="circle spin"></div></div></div>'),t.modals.VIEWUSERS.show(),u.call([{methodname:"local_announcements_get_audienceselector_users",args:{audiencesjson:e},done:function(e){var n=Object.keys(e.userslist).length;p.render(t.templates.VIEWUSERS,e).done(function(e){e="<p><strong>The following "+n+" user(s) will receive this announcement</strong></p>"+e,t.modals.VIEWUSERS.setBody(e)}).fail(function(e){return d.debug(e),"Failed to render announcement user list."})},fail:function(e){d.error("local_announcements/audienceselector: unable to get announcemnt users."),d.debug(e)}}]))},n.prototype.initialiseTreeView=function(e){e.find(".group-name").on("click",function(e){var n=c(this);n.parent().find(".group-items").toggleClass("active"),n.toggleClass("caret-down")})},n.prototype.handleNoItems=function(e,n,t,a){var o=e.find(".items").first();d.debug(t),e.parent().removeClass("loading"),e.addClass("no-items"),o.html(a)},n.prototype.renderTags=function(){var e,n=c('input[name="audiencesjson"]').val(),t=new Array;if(n)for(t=JSON.parse(n),e=0;e<t.length;++e)this.renderTag(t[e]);this.handleTagChanges()},n.prototype.addTag=function(e){var n=e.closest(".contents"),t=this.getSelected(n);if(t){var a=new Array,o=c('input[name="audiencesjson"]');o.val()&&(a=JSON.parse(o.val()));var i={type:"union",uid:Date.now(),audiences:[t]};a.push(i);var s=JSON.stringify(a);o.val(s),this.renderTag(i),this.closeAudienceSelector(n),this.handleTagChanges()}},n.prototype.closeAudienceSelector=function(e){e.removeClass("selected"),e.find(".items input").prop("checked",!1),e.find(".roles input").prop("checked",!1),e.find(".buttons").removeClass("show"),e.hasClass("contents-filterable")&&(e.find(".audience-filter").val(""),e.find(".list li").removeClass("active"))},n.prototype.addIntersection=function(e){var t=this,n=e.closest(".contents"),a=t.getSelectedSplit(n);if(a.length){var o=new Array;t.intersectionjson&&(o=JSON.parse(t.intersectionjson)),c.each(a,function(e,n){o.push(n)}),t.intersectionjson=JSON.stringify(o),c.each(a,function(e,n){t.renderIntersection(n)}),1<o.length&&t.rootel.find(".intersection-workspace").addClass("has-multiple-tags"),t.rootel.find(".audience-intersect-btn").html(t.strings.continueintersection),t.rootel.find(".audience-add-btn").hide(),t.rootel.find(".audience-tab").hide(),t.rootel.find(".audience-tab.contents-intersectable").show(),t.closeAudienceSelector(n)}},n.prototype.finishIntersection=function(e){var n=JSON.parse(this.intersectionjson);if(!(n.length<2)){var t=new Array,a=c('input[name="audiencesjson"]');a.val()&&(t=JSON.parse(a.val()));var o={type:"intersection",uid:Date.now(),audiences:n};t.push(o);var i=JSON.stringify(t);a.val(i),this.renderTag(o),this.clearIntersectionWorkspace(),this.handleTagChanges()}},n.prototype.clearIntersectionWorkspace=function(){var e=this;e.intersectionjson="",e.rootel.find(".audience-add-btn").show(),e.rootel.find(".audience-intersect-btn").html(e.strings.createintersection),e.rootel.find(".audience-tab").show(),e.rootel.find(".intersection-workspace").removeClass("has-tags"),e.rootel.find(".intersection-workspace").removeClass("has-multiple-tags"),e.rootel.find(".intersection-tags-list .box").fadeOut(300,function(){c(this).remove()})},n.prototype.getSelected=function(e){var n=e.data("audienceprovider"),t=e.data("audiencetype"),a=e.data("audiencenamesingular"),o=e.data("audiencenameplural"),i=e.data("audiencehasroles"),s=new Array;if(e.find(".item:checked").each(function(){var e=c(this),n={code:e.val(),name:e.data("name")};s.push(n)}),s.length){if(i){var r=new Array;if(e.find(".role:checked").each(function(){var e=c(this),n={code:e.val(),name:e.data("name")};r.push(n)}),!r.length)return}return{audienceprovider:n,audiencetype:t,audiencenamesingular:a,audiencenameplural:o,selecteditems:s,selectedroles:r}}},n.prototype.getSelectedSplit=function(e){var o=this.getSelected(e),i=new Array;return c.each(o.selecteditems,function(e,n){var t=new Array;t.push(n);var a={audienceprovider:o.audienceprovider,audiencetype:o.audiencetype,audiencenamesingular:o.audiencenamesingular,audiencenameplural:o.audiencenameplural,selecteditems:t,selectedroles:o.selectedroles};i.push(a)}),i},n.prototype.removeTag=function(e){var n,t=e.data("taguid"),a=c('input[name="audiencesjson"]'),o=JSON.parse(a.val()),i=new Array;for(n=0;n<o.length;n++){o[n].uid!=t&&i.push(o[n])}var s="";i.length&&(s=JSON.stringify(i)),a.val(s),e.parent().parent().fadeOut(300,function(){c(this).remove()}),this.handleTagChanges()},n.prototype.renderTag=function(e){var n=this,t=n.rootel.find(".tags .loader");t.addClass("show"),p.render("local_announcements/audience_tag",e).then(function(e){n.rootel.find(".tags-list").append(e),t.removeClass("show")}).fail(function(e){d.error(e)})},n.prototype.renderIntersection=function(e){var n=this,t=n.rootel.find(".intersection-workspace .loader");t.addClass("show"),p.render("local_announcements/intersection_tag",e).then(function(e){n.rootel.find(".intersection-tags-list").append(e),n.rootel.find(".intersection-workspace").addClass("has-tags"),t.removeClass("show")}).fail(function(e){d.error(e)})},n.prototype.handleFitlerChange=function(e){var n=e.parent().find(".list").first();n.find(".more").remove(),n.find("li").removeClass("active");var t=e.val().toLowerCase();if(0==t.length)return!1;var a=0;n.find("li").each(function(){if(name=c(this).find("input").first().data("name").toLowerCase(),0<=name.indexOf(t)){if(50<++a)return n.append(c("<li/>").addClass("more-items active").text("More records are available. be more specific to narrow this down.")),!1;c(this).addClass("active")}})},n.prototype.handleItemChange=function(e){var n=e.closest(".contents"),t=n.data("audiencetype"),a="#contents-"+t,o=a+" .buttons",i=n.data("audiencehasroles"),s=e.closest("."+t+"-item");e.prop("checked")?s.addClass("selected"):s.removeClass("selected"),c(o).removeClass("show"),0<c(a+" .items input:checkbox:checked").length&&(i?0<c(a+" .roles input:checkbox:checked").length&&c(o).addClass("show"):c(o).addClass("show"))},n.prototype.checkForOriginCourse=function(){var e=this.getUrlParameter("type"),n=this.getUrlParameter("code");if(void 0!==e&&void 0!==n){var t=c("[data-audiencetype="+e+"]");this.openTab(t,n)}},n.prototype.getUrlParameter=function(e){var n,t,a=window.location.search.substring(1).split("&");for(t=0;t<a.length;t++)if((n=a[t].split("="))[0]===e)return void 0===n[1]||decodeURIComponent(n[1])},n.prototype.handleTagChanges=function(){this.checkModerationStatus(),this.checkCCGroups();var e=new Array,n=c('input[name="audiencesjson"]');n.val()&&(e=JSON.parse(n.val())),e.length?this.rootel.addClass("has-tags"):this.rootel.removeClass("has-tags")},n.prototype.checkModerationStatus=function(){var i=c(".moderation-status"),s=c(".moderation-status .status"),r=c(".moderation-status .description");r.removeClass("active"),i.removeClass("visible hasmod");var e=c('input[name="audiencesjson"]').val();if(0!=e.length){var l=document.querySelector('input[name="moderatorjson"]');i.addClass("visible loading"),u.call([{methodname:"local_announcements_get_moderation_for_audiences",args:{audiencesjson:e},done:function(e){if(e.required){if(s.html(e.status+' <a class="rule-toggle" href="#">More</a>'),r.html(e.description),i.removeClass("loading").addClass("hasmod"),-1<e.modusername.indexOf("[")){"na"==l.value&&l.value;var n=document.getElementById("id_moderator");n.innerHTML="",(o=document.createElement("option")).value="",o.innerHTML="-- select --",n.appendChild(o);var t=JSON.parse(e.modusername);if(t.length){for(var a=0;a<t.length;++a){var o;(o=document.createElement("option")).value=t[a].username,o.innerHTML=t[a].fullname,n.appendChild(o)}if(""!==l.value)document.querySelector('#id_moderator option[value="'+l.value+'"]')?document.getElementById("id_moderator").value=l.value:l.value="";document.getElementById("id_moderation").classList.add("show")}}}else l.value="na",i.removeClass("loading").removeClass("visible"),document.getElementById("id_moderation").classList.remove("show")},fail:function(e){i.removeClass("visible loading"),d.debug(e)}}])}},n.prototype.checkCCGroups=function(){var t=c(".ccgroups-status"),a=c(".ccgroups-status .status");t.removeClass("visible hasccgroups");var e=c('input[name="audiencesjson"]').val();0!=e.length&&u.call([{methodname:"local_announcements_get_ccgroups_for_audiences",args:{audiencesjson:e},done:function(e){if(t.removeClass("loading"),e){var n=e.join(". ");a.html(n+"."),t.addClass("hasccgroups")}else t.removeClass("visible")},fail:function(e){t.removeClass("visible loading"),d.debug(e)}}])},n.prototype.showModerationRule=function(e){e.closest(".moderation-status").find(".description").first().addClass("active"),e.remove()},n.prototype.loadModal=function(n,t,a,e){var o=this;return i.create({type:e}).then(function(e){e.setTitle(t),a&&e.setSaveButtonText(a),(o.modals[n]=e).getBackdrop(),e.getRoot().addClass("modal-"+n)})},n.prototype.loadTemplate=function(e){return p.render(this.templates[e],{})},{init:function(){d.debug("local_announcements/audienceselector: initializing the audience-selector component");var e=c(".audience-selector").first();e.length?new n(e).main():d.error("local_announcements/audienceselector: audience-selector root element not found!")}}});