{"version":3,"sources":["../src/impersonateselector.js"],"names":["define","$","Log","Ajax","Templates","Str","ImpersonateSelector","rootel","self","component","wildcard","data","hasresults","strings","get_strings","key","then","s","noselectionstr","prototype","main","render","keytimer","on","clearTimeout","autocomplete","val","setTimeout","search","e","preventDefault","tag","add","remove","refocus","document","target","is","unfocus","input","obj","username","photourl","find","attr","fullname","text","JSON","stringify","html","json","parse","console","log","fail","reason","error","searchel","call","methodname","args","query","done","response","length","users","results","addClass","removeClass","debug","init","first","impersonateselector"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for impersonate autocomplete field.\n *\n * @package   local_announcements\n * @category  output\n * @copyright 2020 Michael Vangelovski <michael.vangelovski@hotmail.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_announcements/impersonateselector\n */\ndefine(['jquery', 'core/log', 'core/ajax', 'core/templates', 'core/str'], function($, Log, Ajax, Templates, Str) {\n    'use strict';\n\n    /**\n     * Initializes the impersonateselector component.\n     */\n    function init() {\n        Log.debug('local_announcements/impersonateselector: initializing the impersonate-selector component');\n\n        var rootel = $('.impersonate-selector').first();\n\n        if (!rootel.length) {\n            Log.error('local_announcements/impersonateselector: impersonate-selector root element not found!');\n            return;\n        }\n\n        var impersonateselector = new ImpersonateSelector(rootel);\n        impersonateselector.main();\n    }\n\n    /**\n     * The impersonate selector constructor\n     *\n     * @constructor\n     * @param {jQuery} rootel\n     */\n    function ImpersonateSelector(rootel) {\n        var self = this;\n        self.rootel = rootel;\n        self.component = 'local_announcements';\n        // By default, the element has fields and is treated like a drop down.\n        self.wildcard = false;\n        // Wildcard allows user searching.\n        if (self.rootel.data('wildcard')) {\n            self.wildcard = true;\n        }\n        if (self.rootel.data('hasresults')) {\n            self.hasresults = true;\n        }\n\n        self.strings = {}\n        Str.get_strings([\n            {key: 'postform:impersonatenoselection', component: self.component},\n        ]).then(function(s) {\n            self.strings.noselectionstr = s[0];\n        });\n    }\n\n    /**\n     * Run the Impersonate Selector.\n     *\n     */\n   ImpersonateSelector.prototype.main = function () {\n        var self = this;\n\n        // Render existing selection (if editing announcement).\n        self.render();\n\n        // Handle search.\n        var keytimer;\n        self.rootel.on('keyup', '.impersonate-autocomplete', function(e) {\n            clearTimeout(keytimer);\n            var autocomplete = $(this);\n\n            // If not a search, do not allow typing.\n            if (!self.wildcard) {\n                autocomplete.val('');\n                return;\n            }\n\n            keytimer = setTimeout(function () {\n                self.search(autocomplete);\n            }, 500);\n        });\n\n        // Handle search result click.\n        self.rootel.on('click', '.impersonate-result', function(e) {\n            e.preventDefault();\n            var tag = $(this);\n            self.add(tag);\n        });\n\n        // Handle tag click.\n        self.rootel.on('click', '.impersonate-tag', function(e) {\n            e.preventDefault();\n            var tag = $(this);\n            self.remove(tag);\n        });\n\n        // Handle entering the autocomplete field.\n        self.rootel.on('focus', '.impersonate-autocomplete', function(e) {\n            self.refocus();\n        });\n\n        // Handle leaving the autocomplete field.\n        $(document).on('click', function (e) {\n            var target = $(e.target);\n            if (target.is('.impersonate-autocomplete') || target.is('.impersonate-result')) {\n                return;\n            }\n            self.unfocus();\n        });\n    };\n\n\n    /**\n     * Add a selection.\n     *\n     * @method\n     */\n    ImpersonateSelector.prototype.add = function (tag) {\n        var self = this;\n        self.unfocus();\n\n        var input = $('input[name=\"impersonate\"]');\n\n        // Encode to json and add tag to hidden input.\n        var obj = {\n            username: tag.data('username'),\n            photourl: tag.find('img').attr('src'),\n            fullname: tag.find('span').text()\n        };\n        input.val(JSON.stringify(obj));\n\n        self.render();\n    };\n\n    /**\n     * Remove a selection.\n     *\n     * @method\n     */\n    ImpersonateSelector.prototype.remove = function (tag) {\n        var self = this;\n\n        var input = $('input[name=\"impersonate\"]');\n        input.val('');\n\n        self.render();\n    };\n\n    /**\n     * Render the selection.\n     *\n     * @method\n     */\n    ImpersonateSelector.prototype.render = function () {\n        var self = this;\n        var input = $('input[name=\"impersonate\"]');\n\n        if (input.val() == '') {\n            // Remove tag.\n            self.rootel.find('.impersonate-selection').html(self.strings.noselectionstr);\n            return;\n        }\n\n        var json = input.val();\n        if(json) {\n            var tag = JSON.parse(json);\n\n            console.log(tag);\n            // Render the tag from a template.\n            Templates.render('local_announcements/impersonate_selector_tag', tag)\n                .then(function(html) {\n                    self.rootel.find('.impersonate-selection').html(html);\n                }).fail(function(reason) {\n                    Log.error(reason);\n                });\n        }\n    };\n\n    /**\n     * Search.\n     *\n     * @method\n     */\n    ImpersonateSelector.prototype.search = function (searchel) {\n        var self = this;\n        self.hasresults = false;\n\n        if (searchel.val() == '') {\n            return;\n        }\n\n        Ajax.call([{\n            methodname: 'local_announcements_get_impersonate_users',\n            args: { query: searchel.val() },\n            done: function(response) {\n                if (response.length) {\n                    self.hasresults = true;\n                    // Render the results.\n                    Templates.render('local_announcements/impersonate_selector_results', { users : response }) \n                        .then(function(html) {\n                            var results = self.rootel.find('.impersonate-results');\n                            results.html(html);\n                            results.addClass('active');\n                        }).fail(function(reason) {\n                            Log.error(reason);\n                        });\n                } else {\n                    self.rootel.find('.impersonate-results').removeClass('active');\n                }\n            },\n            fail: function(reason) {\n                Log.error('local_announcements/impersonateselector: failed to search.');\n                Log.debug(reason);\n            }\n        }]);\n    };\n\n    /**\n     * Leave the autocomplete field.\n     *\n     * @method\n     */\n    ImpersonateSelector.prototype.unfocus = function () {\n        var self = this;\n        self.rootel.find('.impersonate-results').removeClass('active');\n    };\n\n    /**\n     * Leave the autocomplete field.\n     *\n     * @method\n     */\n    ImpersonateSelector.prototype.refocus = function () {\n        var self = this;\n        if (self.hasresults) {\n            self.rootel.find('.impersonate-results').addClass('active');\n        }\n    };\n\n    return {\n        init: init\n    };\n});"],"file":"impersonateselector.min.js"}