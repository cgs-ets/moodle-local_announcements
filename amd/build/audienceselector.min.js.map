{"version":3,"sources":["../src/audienceselector.js"],"names":["define","$","Log","Ajax","Templates","Str","ModalFactory","AudienceSelector","rootel","self","component","selectedtabcode","intersectionjson","modals","VIEWUSERS","templates","strings","get_strings","key","then","s","continueintersection","createintersection","prototype","main","renderTags","tabs","find","on","e","preventDefault","tab","openTab","button","addTag","removeTag","addIntersection","finishIntersection","clearIntersectionWorkspace","showModerationRule","keytimer","clearTimeout","filterEl","setTimeout","handleFitlerChange","item","handleItemChange","getUserList","checkForOriginCourse","preloads","loadModal","types","DEFAULT","loadTemplate","when","apply","addClass","preselect","type","data","contents","first","alreadyLoaded","hasClass","currentlyLoadingTab","parent","getAudienceItems","removeClass","namesingular","nameplural","items","call","methodname","args","done","response","template","grouped","render","html","audiencelist","length","audiencelistgrouped","debug","prop","initialiseTreeView","message","get_string","typenameplural","localizedString","handleNoItems","fail","reason","tagsjson","val","getModal","setBody","show","audiencesjson","count","Object","keys","error","groups","groupname","toggleClass","obj","debugMessage","userMessage","tags","JSON","parse","i","renderTag","handleTagChanges","closest","selectedaudience","getSelected","audiencesJSON","tag","uid","Date","now","audiences","push","tagStr","stringify","closeAudienceSelector","selectedaudiences","getSelectedSplit","intersectiontags","each","audience","renderIntersection","hide","fadeOut","remove","audienceprovider","audiencetype","audiencenamesingular","audiencenameplural","audiencehasroles","selecteditems","input","code","name","selectedroles","singletag","splitaudiences","removeuid","tagsnew","curruid","loader","append","filter","list","search","toLowerCase","foundresults","indexOf","text","contentsid","btnclass","hasroles","li","getUrlParameter","sParam","sPageURL","window","location","substring","sURLVariables","split","sParameterName","decodeURIComponent","checkModerationStatus","checkCCGroups","moderationroot","moderationstatus","moderationdesc","moderationajax","mod","required","status","description","ccgroupsroot","ccgroupsstatus","ccgroups","join","moderationinfo","modalkey","title","buttontext","create","modal","setTitle","setSaveButtonText","getBackdrop","getRoot","templatekey","init","audienceselector"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides the local_announcements/audienceselector module\n *\n * @package   local_announcements\n * @category  output\n * @copyright 2020 Michael Vangelovski <michael.vangelovski@hotmail.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_announcements/audienceselector\n */\ndefine(['jquery', 'core/log', 'core/ajax','core/templates', 'core/str', 'core/modal_factory', 'core/modal_events'], function($, Log, Ajax, Templates, Str, ModalFactory, ModalEvents) {\n    'use strict';\n\n    /**\n     * Initializes the audienceselector component.\n     */\n    function init() {\n        Log.debug('local_announcements/audienceselector: initializing the audience-selector component');\n\n        var rootel = $('.audience-selector').first();\n\n        if (!rootel.length) {\n            Log.error('local_announcements/audienceselector: audience-selector root element not found!');\n            return;\n        }\n\n        var audienceselector = new AudienceSelector(rootel);\n        audienceselector.main();\n    }\n\n    /**\n     * The audience selector constructor\n     *\n     * @constructor\n     * @param {jQuery} rootel\n     */\n    function AudienceSelector(rootel) {\n        var self = this;\n        self.rootel = rootel;\n        self.component = 'local_announcements';\n\n        // Global vars.\n        self.selectedtabcode = '';\n        self.intersectionjson = '';\n\n        self.modals = {\n            VIEWUSERS: null,\n        };\n        self.templates = {\n            VIEWUSERS: 'local_announcements/announcement_users_list',\n        };\n\n        // Get some strings for future use.\n        self.strings = {}\n        Str.get_strings([\n            {key: 'audienceselector:continueintersection', component: self.component},\n            {key: 'audienceselector:createintersection', component: self.component},\n        ]).then(function(s) {\n            self.strings.continueintersection = s[0];\n            self.strings.createintersection = s[1];\n        });\n    }\n\n    /**\n     * Run the Audience Selector.\n     *\n     */\n   AudienceSelector.prototype.main = function () {\n        var self = this;\n\n        // Render existing tags (if editing announcement).\n        self.renderTags();\n\n        // Handle audience type tab click.\n        var tabs = self.rootel.find('.audience-tab');\n        tabs.on('click', function(e) {\n            e.preventDefault();\n            var tab = $(this);\n            self.openTab(tab);\n        });\n\n        // Handle add audience button click.\n        self.rootel.on('click', '.audience-add-btn', function(e) {\n            e.preventDefault();\n            var button = $(this);\n            self.addTag(button);\n        });\n\n        // Handle remove tags button click.\n        self.rootel.on('click', '.remove-tag', function(e) {\n            e.preventDefault();\n            var button = $(this);\n            self.removeTag(button);\n        });\n\n        // Handle add to intersection button click.\n        self.rootel.on('click', '.audience-intersect-btn', function(e) {\n            e.preventDefault();\n            var button = $(this);\n            self.addIntersection(button);\n        });\n\n        // Handle finish intersection button click.\n        self.rootel.on('click', '.intersection-finish-btn', function(e) {\n            e.preventDefault();\n            self.finishIntersection();\n        });\n\n        // Handle cancel intersection button click.\n        self.rootel.on('click', '.intersection-cancel-btn', function(e) {\n            e.preventDefault();\n            self.clearIntersectionWorkspace();\n        });\n\n        // Handle moderation rule toggle.\n        self.rootel.on('click', '.rule-toggle', function(e) {\n            e.preventDefault();\n            var button = $(this);\n            self.showModerationRule(button);\n        });\n\n        // Handle key on filter\n        var keytimer;\n        self.rootel.on('keyup', '.audience-filter', function(e) {\n            clearTimeout(keytimer);\n            var filterEl = $(this);\n            keytimer = setTimeout(function () {\n                self.handleFitlerChange(filterEl);\n            }, 500);\n        });\n\n        // Handle audience item selection\n        self.rootel.on('change', 'input:checkbox', function(e) {\n            var item = $(this);\n            self.handleItemChange(item);\n        });\n\n        // Handle view user list click\n        self.rootel.on('click', '#action-viewusers', function(e) {\n            e.preventDefault();\n            self.getUserList();\n        });\n\n\n        self.checkForOriginCourse();\n\n        // Preload the modals and templates.\n        var preloads = [];\n        preloads.push(self.loadModal('VIEWUSERS', 'Preview recipients', '', ModalFactory.types.DEFAULT));\n        preloads.push(self.loadTemplate('VIEWUSERS'));\n        // Do not show actions until all modals and templates are preloaded.\n        $.when.apply($, preloads).then(function() {\n            self.rootel.addClass('preloads-completed');\n        })\n\n    };\n\n\n    /**\n     * Open and fill audience provider tab.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.openTab = function (tab, preselect) {\n        var self = this;\n\n        // Get handles to needed elements\n        var type = tab.data('audiencetype');\n        var contents = self.rootel.find('.contents[data-audiencetype=\"' + type +'\"]').first();\n\n        \n        var alreadyLoaded = contents.hasClass('loaded');\n        var currentlyLoadingTab = ( contents.parent().hasClass('loading') && self.selectedtabcode == type );\n\n        // Load the audience type data if not already loaded or currently loading.\n        if ( !alreadyLoaded && !currentlyLoadingTab ) {\n            self.selectedtabcode = type;\n            // Load the audience type contents\n            self.getAudienceItems(tab, contents, preselect);\n            // Add the loading animation\n            contents.parent().addClass('loading');\n        }\n\n        //Hide all contents and show the relevant one\n        self.rootel.find('.contents').removeClass('selected');\n        contents.addClass('selected');\n\n    };\n\n\n    /**\n     * Get the list of audience associations for the selected audience.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.getAudienceItems = function (tab, contents, preselect) {\n        var self = this;\n        var type = tab.data('audiencetype');\n        var namesingular = contents.data('audiencenamesingular');\n        var nameplural = contents.data('audiencenameplural');\n        var items = contents.find('.items').first();\n\n        Ajax.call([{\n            methodname: 'local_announcements_get_audience_items',\n            args: { type: type },\n            done: function(response) {\n                // Render the audience items.\n                var template = 'local_announcements/audience_list';\n                if (response.grouped) {\n                    var template = 'local_announcements/audience_list_tree';\n                }\n                Templates.render(template, response) \n                    .then(function(html) {\n                        if (response.audiencelist.length || response.audiencelistgrouped.length) {\n                            items.html(html);\n                            if (preselect) {\n                                Log.debug(\"Preselecting: \" + preselect);\n                                contents.find('.item[value=\"' + preselect + '\"]').first().prop('checked', true);\n                            }\n                            if (response.grouped) {\n                                self.initialiseTreeView(contents);\n                            }\n                            if (response.audiencelist.length > 10) {\n                                contents.find('.list').addClass('list-gt10');\n                            }\n                            contents.parent().removeClass('loading');\n                            contents.addClass('loaded');\n                        } else {\n                            var message = Str.get_string('audienceselector:noaudienceitems', 'local_announcements', response.typenameplural);\n                            $.when(message).done(function(localizedString) {\n                                self.handleNoItems(contents, response, 'local_announcements/audienceselector: User is not a member of any ' + nameplural + '.', localizedString);\n                            });\n                        }\n                    }).fail(function(reason) {\n                        self.handleNoItems(contents, reason, 'local_announcements/audienceselector: Failed to render audience items.', 'Failed to get ' + namesingular + ' associations.');\n                    });\n            },\n            fail: function(reason) {\n                self.handleNoItems(contents, reason, 'local_announcements/audienceselector: Failed to get audience items', 'Failed to get ' + namesingular + ' associations.');\n            }\n        }]);\n    };\n\n\n    /**\n     * Get the list of audience associations for the selected audience.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.getUserList = function () {\n        var self = this;\n        var tagsjson = $('input[name=\"audiencesjson\"]').val();\n        if (self.modals.VIEWUSERS) {\n            self.modals.VIEWUSERS.getModal().addClass('modal-xl');\n            self.modals.VIEWUSERS.setBody('<div style=\"font-style:italic;\">... Fetching user list ...<div class=\"loader\" style=\"display:block;\"><div class=\"circle spin\"></div></div></div>');\n            self.modals.VIEWUSERS.show();\n            Ajax.call([{\n                methodname: 'local_announcements_get_audienceselector_users',\n                args: { audiencesjson: tagsjson },\n                done: function(response) {\n                    var count = Object.keys(response['userslist']).length;\n                    //self.modals.VIEWUSERS.setTitle('Audience Users');\n                    Templates.render(self.templates.VIEWUSERS, response)\n                        .done(function(html) {\n                            html = '<p><strong>The following ' + count + ' user(s) will receive this announcement</strong></p>' + html;\n                            self.modals.VIEWUSERS.setBody(html);\n                        })\n                        .fail(function(reason) {\n                            Log.debug(reason);\n                            return \"Failed to render announcement user list.\"\n                        });\n                },\n                fail: function(reason) {\n                    Log.error('local_announcements/audienceselector: unable to get announcemnt users.');\n                    Log.debug(reason);\n                }\n            }]);\n        }\n    };\n\n\n    /**\n     * Initialise tree view.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.initialiseTreeView = function (contents) {\n        var groups = contents.find(\".group-name\");\n        groups.on('click', function(e) {\n            var groupname = $(this);\n            groupname.parent().find(\".group-items\").toggleClass(\"active\");\n            groupname.toggleClass(\"caret-down\");\n        });\n    };\n\n\n    /**\n     * Get the list of audience associations for the selected audience.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.handleNoItems = function (contents, obj, debugMessage, userMessage) {\n        var items = contents.find('.items').first();\n        Log.debug(debugMessage);\n        contents.parent().removeClass('loading');\n        contents.addClass('no-items');\n        items.html(userMessage); \n    };\n\n    /**\n     * Display the tags from the hidden input.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.renderTags = function () {\n        var self = this;\n        var tagsjson = $('input[name=\"audiencesjson\"]').val();\n        var tags = new Array();\n        if(tagsjson) {\n            tags = JSON.parse(tagsjson);\n            var i;\n            for (i = 0; i < tags.length; ++i) {\n                self.renderTag(tags[i]);\n            }\n        }\n        // Check moderation status.\n        self.handleTagChanges();\n    };\n\n\n    /**\n     * Get the list of audience associations for the selected audience.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.addTag = function (button) {\n        var self = this;\n        var contents = button.closest('.contents');\n        \n        // Extract the selected audiences.\n        var selectedaudience = self.getSelected(contents);\n        if (!selectedaudience) {\n            return;\n        }\n\n        // Create the tag.\n        var tags = new Array();\n        var audiencesJSON = $('input[name=\"audiencesjson\"]');\n        if(audiencesJSON.val()) {\n            tags = JSON.parse(audiencesJSON.val());\n        }\n\n        var tag = {\n            type: \"union\",\n            uid : Date.now(),\n            audiences: [\n                selectedaudience,\n            ],\n        };\n        tags.push(tag);\n\n        // Encode to json and add tag to hidden input.\n        var tagStr = JSON.stringify(tags);\n        audiencesJSON.val(tagStr);\n\n        // Render the tag.\n        self.renderTag(tag);\n\n        // Clear and close the audience selector page.\n        self.closeAudienceSelector(contents);\n\n        // Check moderation status.\n        self.handleTagChanges();\n\n    };\n\n    /**\n     * Clear and close the audience selector page\n     *\n     * @method\n     */\n    AudienceSelector.prototype.closeAudienceSelector = function (contents) {\n        contents.removeClass('selected');\n        contents.find(\".items input\").prop(\"checked\", false);\n        contents.find(\".roles input\").prop(\"checked\", false);\n        contents.find(\".buttons\").removeClass('show');\n        if (contents.hasClass('contents-filterable')) {\n            contents.find(\".audience-filter\").val('');\n            contents.find('.list li').removeClass('active');\n        }\n    };\n\n    /**\n     * Add the selected audience to the intersection workspace.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.addIntersection = function (button) {\n        var self = this;\n        var contents = button.closest('.contents');\n        \n        // Extract the selected audiences.\n        var selectedaudiences = self.getSelectedSplit(contents);\n        if (!selectedaudiences.length) {\n            return;\n        }\n\n        // Create the tag.\n        var intersectiontags = new Array();\n        if(self.intersectionjson) {\n            intersectiontags = JSON.parse(self.intersectionjson);\n        }\n        $.each(selectedaudiences, function( i, audience ) {\n            intersectiontags.push(audience);\n        });\n\n        // Encode to json and add tag to hidden input.\n        self.intersectionjson = JSON.stringify(intersectiontags);\n\n        // Call function to render tag.\n        $.each(selectedaudiences, function( i, audience ) {\n            self.renderIntersection(audience);\n        });\n\n        // Show the finish intersection button if there is at least 2 tags. This is done via css.\n        if (intersectiontags.length > 1) {\n            self.rootel.find('.intersection-workspace').addClass('has-multiple-tags');\n        }\n\n        // Now that we are in the process of building an intersection update the add intersection button name.\n        self.rootel.find(\".audience-intersect-btn\").html(self.strings.continueintersection);\n        // Also remove the Add users button.\n        self.rootel.find(\".audience-add-btn\").hide();\n        // Also hide any tabs that do not allow for intersections.\n        self.rootel.find(\".audience-tab\").hide();\n        self.rootel.find(\".audience-tab.contents-intersectable\").show();\n\n        // Clear and close the audience selector page.\n        self.closeAudienceSelector(contents);\n    };\n\n    /**\n     * Add the selected audience to the intersection workspace.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.finishIntersection = function (button) {\n        var self = this;\n        \n        // Extract the intersected audiences.\n        var intersectiontags = JSON.parse(self.intersectionjson);\n        if (intersectiontags.length < 2) {\n            // This should never happen.\n            return;\n        }\n\n        // Get the current tags.\n        var tags = new Array();\n        var audiencesJSON = $('input[name=\"audiencesjson\"]');\n        if(audiencesJSON.val()) {\n            tags = JSON.parse(audiencesJSON.val());\n        }\n\n        // Setup the new tag.\n        var tag = {\n            type: \"intersection\",\n            uid : Date.now(),\n            audiences: intersectiontags,\n        };\n\n        // Add the new tag to the list.\n        tags.push(tag);\n\n        // Encode the tags list to json and add tag to hidden input.\n        var tagStr = JSON.stringify(tags);\n        audiencesJSON.val(tagStr);\n\n        // Render the new tag.\n        self.renderTag(tag);\n\n        // Clear the intersection workspace.\n        self.clearIntersectionWorkspace();\n\n        // Check moderation status.\n        self.handleTagChanges();\n    };\n\n    /**\n     * Add the selected audience to the intersection workspace.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.clearIntersectionWorkspace = function () {\n        var self = this;\n        // Clear the intersection workspace.\n        self.intersectionjson = '';\n        // Show the add button again.\n        self.rootel.find(\".audience-add-btn\").show();\n        // Change the name of the add intersection button.\n        self.rootel.find('.audience-intersect-btn').html(self.strings.createintersection);\n        // Show all audience tabs again.\n        self.rootel.find(\".audience-tab\").show();\n        // Clear the intersection workspace.\n        self.rootel.find('.intersection-workspace').removeClass('has-tags');\n        self.rootel.find('.intersection-workspace').removeClass('has-multiple-tags');\n        self.rootel.find('.intersection-tags-list .box').fadeOut(300, function() {\n            $(this).remove();\n        });\n    };\n\n    /**\n     * Get the selected items.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.getSelected = function (contents) {\n        var audienceprovider = contents.data('audienceprovider');\n        var audiencetype = contents.data('audiencetype');\n        var audiencenamesingular = contents.data('audiencenamesingular');\n        var audiencenameplural = contents.data('audiencenameplural');\n        var audiencehasroles = contents.data('audiencehasroles');\n\n        // get selected items\n        var selecteditems = new Array();\n        contents.find('.item:checked').each(function() {\n            var input = $(this);\n            var item = {\n                code: input.val(),\n                name: input.data('name'),\n            }\n            selecteditems.push(item);\n        });\n\n        if ( !selecteditems.length ) {\n            return;\n        }\n\n        if (audiencehasroles) {\n            // get selected roles\n            var selectedroles = new Array();\n            contents.find('.role:checked').each(function() {\n                var input = $(this);\n                var item = {\n                    code: input.val(),\n                    name: input.data('name'),\n                }\n                selectedroles.push(item);\n            });\n\n            if ( !selectedroles.length ) {\n                return;\n            }\n        }\n\n        return {\n            audienceprovider: audienceprovider,\n            audiencetype: audiencetype,\n            audiencenamesingular: audiencenamesingular,\n            audiencenameplural: audiencenameplural,\n            selecteditems: selecteditems,\n            selectedroles: selectedroles,\n        };\n\n    };\n\n\n/**\n     * Get the selected items. Where multiple are selected, create individual tags.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.getSelectedSplit = function (contents) {\n        var self = this;\n        var singletag = self.getSelected(contents);\n\n        // Create multiple tags from one. One for each selected item.\n        var splitaudiences = new Array();\n        $.each(singletag.selecteditems, function( i, item ) {\n            var items = new Array();\n            items.push(item);\n            var tag = {\n                audienceprovider: singletag.audienceprovider,\n                audiencetype: singletag.audiencetype,\n                audiencenamesingular: singletag.audiencenamesingular,\n                audiencenameplural: singletag.audiencenameplural,\n                selecteditems: items,\n                selectedroles: singletag.selectedroles,\n            };\n            splitaudiences.push(tag);\n        });\n\n        return splitaudiences;\n    };\n\n    /**\n     * Get the list of audience associations for the selected audience.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.removeTag = function (button) {\n        var self = this;\n        var removeuid = button.data('taguid');\n        var audiencesJSON = $('input[name=\"audiencesjson\"]');\n        var tags = JSON.parse(audiencesJSON.val());\n        var tagsnew = new Array();\n        var i;\n        for (i = 0; i < tags.length; i++) {\n            var curruid = tags[i]['uid'];\n            if (curruid != removeuid) {\n                tagsnew.push(tags[i]);\n            }\n        }\n        var tagStr = '';\n        if (tagsnew.length) {\n            tagStr = JSON.stringify(tagsnew);\n        }\n        audiencesJSON.val(tagStr);\n        button.parent().parent().fadeOut(300, function(){\n            $(this).remove();\n        });\n\n        // Check moderation status.\n        self.handleTagChanges();\n    };\n\n    /**\n     * Render a audience tag string and append to the selected audiences list\n     *\n     * @method\n     */\n    AudienceSelector.prototype.renderTag = function (tag) {\n        var self = this;\n        var loader = self.rootel.find('.tags .loader');\n        loader.addClass('show');\n        // Render the tag from a template\n        Templates.render('local_announcements/audience_tag', tag)\n            .then(function(html) {\n                self.rootel.find('.tags-list').append(html);\n                loader.removeClass('show');\n            }).fail(function(reason) {\n                Log.error(reason);\n            });\n    };\n\n    /**\n     * Render a audience tag string and append to the selected audiences list\n     *\n     * @method\n     */\n    AudienceSelector.prototype.renderIntersection = function (tag) {\n        var self = this;\n        var loader = self.rootel.find('.intersection-workspace .loader');\n        loader.addClass('show');\n        // Render the tag from a template\n        Templates.render('local_announcements/intersection_tag', tag)\n            .then(function(html) {\n                self.rootel.find('.intersection-tags-list').append(html);\n                self.rootel.find('.intersection-workspace').addClass('has-tags');\n                loader.removeClass('show');\n            }).fail(function(reason) {\n                Log.error(reason);\n            });\n    };\n\n    /**\n     * Check to see if a filter is present or not, and show list depending.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.handleFitlerChange = function (filter) {\n        var contents = filter.parent();\n        var list = contents.find('.list').first();\n        list.find('.more').remove();\n        // clear active/found items.\n        list.find('li').removeClass('active');\n        // get search string.\n        var search = filter.val().toLowerCase();\n        if (search.length == 0) {\n            return false;\n        }\n        // search items.\n        var maxresults = 50;\n        var foundresults = 0;\n        list.find('li').each(function() {\n            name = $(this).find('input').first().data('name').toLowerCase();\n            if ( name.indexOf(search) >= 0 ) {\n                foundresults++;\n                if ( foundresults > maxresults ) {\n                    list.append(\n                        $('<li/>')\n                            .addClass(\"more-items active\")\n                            .text(\"More records are available. be more specific to narrow this down.\")\n                    );\n                    return false;\n                }\n                $(this).addClass('active');\n            }\n        });\n    };\n\n    /**\n     * Check to see if an item is selected or not, and show add audience button depending.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.handleItemChange = function (item) {\n        var contents = item.closest('.contents');\n        var type = contents.data('audiencetype');\n        var contentsid = '#contents-' + type;\n        var btnclass =  contentsid + ' .buttons';\n        var hasroles = contents.data('audiencehasroles');\n        var li = item.closest('.' + type +'-item');\n\n        if (item.prop('checked')) {\n            li.addClass('selected');\n        } else {\n            li.removeClass('selected');\n        }\n\n        $(btnclass).removeClass('show');\n        if ($(contentsid + ' .items input:checkbox:checked').length > 0) {\n            if (hasroles) {\n                if ($(contentsid + ' .roles input:checkbox:checked').length > 0) {\n                    $(btnclass).addClass('show');\n                }\n            } else {\n                $(btnclass).addClass('show');\n            }\n        }\n    };\n\n\n\n    /**\n     * Check if coming from a course then load audience and preselect course.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.checkForOriginCourse = function () {\n        var self = this;\n        var type = self.getUrlParameter('type');\n        var code = self.getUrlParameter('code');\n        if (type === undefined || code === undefined) {\n            return;\n        }\n        var tab = $('[data-audiencetype=' + type +']');\n        self.openTab(tab, code);\n\n    };\n\n    /**\n     * Helper method to get param from query string.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.getUrlParameter = function (sParam) {\n        var sPageURL = window.location.search.substring(1),\n            sURLVariables = sPageURL.split('&'),\n            sParameterName,\n            i;\n\n        for (i = 0; i < sURLVariables.length; i++) {\n            sParameterName = sURLVariables[i].split('=');\n\n            if (sParameterName[0] === sParam) {\n                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);\n            }\n        }\n    };\n\n\n\n    AudienceSelector.prototype.handleTagChanges = function () {\n        var self = this;\n        // Check moderation status.\n        self.checkModerationStatus();\n        self.checkCCGroups();\n\n        var tags = new Array();\n        var audiencesJSON = $('input[name=\"audiencesjson\"]');\n        if(audiencesJSON.val()) {\n            tags = JSON.parse(audiencesJSON.val());\n        }\n        // If has tags add class to audience selector\n        if (tags.length) {\n            self.rootel.addClass('has-tags');\n        } else {\n            self.rootel.removeClass('has-tags');\n        }\n    }\n\n\n    /**\n     * Refresh the moderation status for the selected audiences.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.checkModerationStatus = function () {\n        var moderationroot = $('.moderation-status');\n        var moderationstatus = $('.moderation-status .status');\n        var moderationdesc = $('.moderation-status .description');\n        var moderationajax = $('.moderation-status .ajax');\n        moderationdesc.removeClass('active');\n        moderationroot.removeClass('visible hasmod');\n        \n        var tagsjson = $('input[name=\"audiencesjson\"]').val();\n        if (tagsjson.length == 0) {\n            return;\n        }\n\n        moderationroot.addClass('visible loading');\n        Ajax.call([{\n            methodname: 'local_announcements_get_moderation_for_audiences',\n            args: { audiencesjson: tagsjson },\n            done: function(mod) {\n                if (mod.required) {\n                    moderationstatus.html(mod.status + ' <a class=\"rule-toggle\" href=\"#\">More</a>');\n                    moderationdesc.html(mod.description);\n                    moderationroot.removeClass('loading').addClass('hasmod');                    \n                } else {\n                    moderationroot.removeClass('loading').removeClass('visible')\n                }\n            },\n            fail: function(reason) {\n                moderationroot.removeClass('visible loading');\n                Log.debug(reason);\n            }\n        }]);\n    };\n\n    /**\n     * Check cc groups for the selected audiences.\n     *\n     * @method\n     */\n    AudienceSelector.prototype.checkCCGroups = function () {\n\n        var ccgroupsroot = $('.ccgroups-status');\n        var ccgroupsstatus = $('.ccgroups-status .status');\n        ccgroupsroot.removeClass('visible hasccgroups');\n        \n        var tagsjson = $('input[name=\"audiencesjson\"]').val();\n        if (tagsjson.length == 0) {\n            return;\n        }\n\n        // Hide this for from user for now. Leave in html for debugging.\n        //ccgroupsroot.addClass('visible loading');\n        Ajax.call([{\n            methodname: 'local_announcements_get_ccgroups_for_audiences',\n            args: { audiencesjson: tagsjson },\n            done: function(ccgroups) {\n                ccgroupsroot.removeClass('loading')\n                if (ccgroups) {\n                    var description = ccgroups.join('. ');\n                    ccgroupsstatus.html(description + '.');\n                    ccgroupsroot.addClass('hasccgroups');\n                } else {\n                    ccgroupsroot.removeClass('visible')\n                }\n            },\n            fail: function(reason) {\n                ccgroupsroot.removeClass('visible loading');\n                Log.debug(reason);\n            }\n        }]);\n    };\n\n    /**\n     * Toggle moderation rule\n     *\n     * @method\n     */\n    AudienceSelector.prototype.showModerationRule = function (button) {\n        var self = this;\n        var moderationinfo = button.closest('.moderation-status');\n        var description = moderationinfo.find('.description').first();\n        description.addClass('active');\n        button.remove();\n    };\n\n    /**\n     * Helper used to preload a modal\n     *\n     * @method loadModal\n     * @param {string} modalkey The property of the global modals variable\n     * @param {string} title The title of the modal\n     * @param {string} title The button text of the modal\n     * @return {object} jQuery promise\n     */\n    AudienceSelector.prototype.loadModal = function (modalkey, title, buttontext, type) {\n        var self = this;\n        return ModalFactory.create({type: type}).then(function(modal) {\n            modal.setTitle(title);\n            if (buttontext) {\n                modal.setSaveButtonText(buttontext);\n            }\n            self.modals[modalkey] = modal;\n            // Preload backgrop.\n            modal.getBackdrop();\n            modal.getRoot().addClass('modal-' + modalkey);\n        });\n    }\n\n    /**\n     * Helper used to preload a template\n     *\n     * @method loadModal\n     * @param {string} templatekey The property of the global templates variable\n     * @return {object} jQuery promise\n     */\n    AudienceSelector.prototype.loadTemplate = function (templatekey) {\n        var self = this;\n        return Templates.render(self.templates[templatekey], {});\n    }\n\n\n    return {\n        init: init\n    };\n});"],"file":"audienceselector.min.js"}