define(["jquery","core/log","core/config","core/ajax","core/templates","core/modal_factory","core/modal_events"],function(s,i,c,d,m,r,u){"use strict";function n(e){var n=this;n.rootel=e,n.modals={APPROVE:null,REJECT:null,DEFER:null,VIEWUSERS:null},n.templates={REJECT:"local_announcements/moderation_modal_reject",DEFER:"local_announcements/moderation_modal_defer",VIEWUSERS:"local_announcements/announcement_users_list"},n.ispagesingle=s("body").hasClass("moderation-single"),n.ver="local_announcements_2019072200"}return n.prototype.main=function(){var o=this;o.rootel.on("click",".announcement .action-approve",function(e){e.preventDefault();var n=s(this);o.approveAnnouncement(n)}),o.rootel.on("click",".announcement .action-reject",function(e){e.preventDefault();var n=s(this);o.rejectAnnouncement(n)}),o.rootel.on("click",".announcement .action-defer",function(e){e.preventDefault();var n=s(this);o.deferAnnouncement(n)}),o.rootel.on("click",".announcement .action-viewusers",function(e){e.preventDefault();var n=s(this);o.viewAnnouncementUsers(n)});var e=[];e.push(o.loadModal("APPROVE","Approve Announcement","Approve",r.types.SAVE_CANCEL)),e.push(o.loadModal("REJECT","Reject Announcement","Reject",r.types.SAVE_CANCEL)),e.push(o.loadModal("DEFER","Reassign Moderation","Reassign",r.types.SAVE_CANCEL)),e.push(o.loadModal("ERROR","Error","",r.types.DEFAULT)),e.push(o.loadModal("VIEWUSERS","Announcement Recipients")),e.push(o.loadTemplate("REJECT")),e.push(o.loadTemplate("VIEWUSERS")),s.when.apply(s,e).then(function(){o.rootel.addClass("preloads-completed")})},n.prototype.approveAnnouncement=function(e){var n=this,o=e.closest(".announcement"),t=o.find(".subject").first().html(),a=o.data("id");n.modals.APPROVE&&(n.modals.APPROVE.setBody('<p>Please confirm that you want to approve:<br><span style="font-style:italic;">'+t+"</span></p>"),n.modals.APPROVE.getRoot().on(u.save,function(e){d.call([{methodname:"local_announcements_mod_approve",args:{id:a},done:function(e){o.addClass("removing"),o.fadeOut(1e3,function(){o.remove(),n.ispagesingle&&(window.location.href=c.wwwroot+"/local/announcements/moderation.php")})},fail:function(e){i.error("local_announcements/moderation: failed to approve the announcement"),i.debug(e)}}])}),n.modals.APPROVE.show())},n.prototype.rejectAnnouncement=function(e){var o=this,t=e.closest(".announcement"),n={subject:t.find(".subject").first().html(),author:t.find(".author").first().html()},a=t.data("id");o.modals.REJECT&&(m.render(o.templates.REJECT,n,o.ver).done(function(e){o.modals.REJECT.setBody(e);var n=s('[name="reject-comment"]');o.modals.REJECT.getRoot().on(u.save,function(e){if(""==n.val())return e.preventDefault(),void n.addClass("is-invalid");d.call([{methodname:"local_announcements_mod_reject",args:{id:a,comment:n.val()},done:function(e){t.addClass("removing"),t.fadeOut(1e3,function(){t.remove(),o.ispagesingle&&(window.location.href=c.wwwroot+"/local/announcements/moderation.php")})},fail:function(e){i.error("local_announcements/moderation: failed to reject the announcement"),i.debug(e)}}])})}),o.modals.REJECT.show())},n.prototype.deferAnnouncement=function(e){var a=this,r=e.closest(".announcement"),l=r.data("id");if(a.modals.DEFER)d.call([{methodname:"local_announcements_get_alternate_moderators",args:{postid:l},done:function(e){if(0!=e.moderators.length){var n={subject:r.find(".subject").first().html(),author:r.find(".author").first().html(),moderators:e};m.render(a.templates.DEFER,n,a.ver).done(function(e){a.modals.DEFER.setBody(e);var n=s('[name="defer-moderator"]'),o=n.children("option:selected").val(),t=s('[name="defer-comment"]').val();a.modals.DEFER.getRoot().on(u.save,function(e){if(""==o)return e.preventDefault(),void n.addClass("is-invalid");d.call([{methodname:"local_announcements_mod_defer",args:{id:l,moderator:o,comment:t},done:function(e){r.addClass("removing"),r.fadeOut(1e3,function(){r.remove(),a.ispagesingle&&(window.location.href=c.wwwroot+"/local/announcements/moderation.php")})},fail:function(e){i.error("local_announcements/moderation: failed to reassign the announcement"),i.debug(e)}}])})}),a.modals.DEFER.show()}else a.showError("<p>There are no moderators with equivalent or higher privileges than you.</p>")},fail:function(e){i.error("local_announcements/moderation: failed to get the list of alternate moderators"),i.debug(e),a.showError("<p>Failed to retrieve a list of alternate moderators.</p>")}}])},n.prototype.viewAnnouncementUsers=function(e){var n=this,o=e.closest(".announcement").data("id");n.modals.VIEWUSERS&&(n.modals.VIEWUSERS.setBody('<div style="font-style:italic;">... Fetching user list ...<div class="loader" style="display:block;"><div class="circle spin"></div></div></div>'),n.modals.VIEWUSERS.show(),d.call([{methodname:"local_announcements_get_announcement_users",args:{id:o},done:function(e){m.render(n.templates.VIEWUSERS,e,n.ver).done(function(e){n.modals.VIEWUSERS.setBody(e)}).fail(function(e){return i.debug(e),"Failed to render announcement user list."})},fail:function(e){i.error("local_announcements/list: unable to get announcemnt users."),i.debug(e)}}]))},n.prototype.loadModal=function(n,o,t,e){var a=this;return r.create({type:e}).then(function(e){e.setTitle(o),t&&e.setSaveButtonText(t),(a.modals[n]=e).getBackdrop()})},n.prototype.loadTemplate=function(e){return m.render(this.templates[e],{},this.ver)},n.prototype.showError=function(e){this.modals.ERROR.setBody(e),this.modals.ERROR.show()},{init:function(){i.debug("local_announcements/moderation: initializing");var e=s(".lann-moderation").first();e.length?new n(e).main():i.error("local_announcements/moderation: .local_announcements element not found!")}}});