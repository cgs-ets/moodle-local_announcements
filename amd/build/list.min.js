define(["jquery","core/log","core/config","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events"],function(s,l,t,i,o,e,c,r){"use strict";function a(e){var n=this;n.rootel=e,n.modals={DELETE:null,VIEWUSERS:null,VIEWAS:null},n.templates={VIEWUSERS:"local_announcements/announcement_users_list"}}return a.prototype.main=function(){var t=this;t.rootel.on("click",".announcement .action-delete",function(e){e.preventDefault();var n=s(this);t.deleteAnnouncement(n)}),t.rootel.on("click",".announcement .action-viewusers",function(e){e.preventDefault();var n=s(this);t.viewAnnouncementUsers(n)}),t.rootel.on("click",".option-viewas",function(e){e.preventDefault(),t.viewAs()});var e=[];if(e.push(t.loadModal("DELETE","Delete Announcement","Delete",c.types.SAVE_CANCEL)),e.push(t.loadModal("VIEWUSERS","Announcement Recipients","",c.types.DEFAULT)),e.push(t.loadModal("VIEWAS","View as another user","Go",c.types.SAVE_CANCEL)),e.push(t.loadTemplate("VIEWUSERS")),s.when.apply(s,e).then(function(){t.rootel.addClass("preloads-completed")}),"undefined"!=typeof InfiniteScroll)new InfiniteScroll(".lann-list",{path:".next",append:".announcement",history:!1,status:".page-load-status"})},a.prototype.viewAs=function(){var e=this;e.modals.VIEWAS&&(e.modals.VIEWAS.setBody('<p>Enter the ID of a user:</p><p><input class="form-control" id="viewas-user" size="48"/></p>'),e.modals.VIEWAS.getRoot().on(r.save,function(e){var n=s("input#viewas-user").val();window.location.href=t.wwwroot+"/local/announcements/index.php?viewas="+n}),e.modals.VIEWAS.show())},a.prototype.viewAnnouncementUsers=function(e){var t=this,n=e.closest(".announcement").data("id");t.modals.VIEWUSERS&&(t.modals.VIEWUSERS.getModal().addClass("modal-xl"),t.modals.VIEWUSERS.setBody('<div style="font-style:italic;">... Fetching user list ...<div class="loader" style="display:block;"><div class="circle spin"></div></div></div>'),t.modals.VIEWUSERS.show(),i.call([{methodname:"local_announcements_get_announcement_users",args:{id:n},done:function(e){var n=Object.keys(e.userslist).length;t.modals.VIEWUSERS.setTitle("Audience Recipients ("+n+")"),o.render(t.templates.VIEWUSERS,e).done(function(e){t.modals.VIEWUSERS.setBody(e)}).fail(function(e){return l.debug(e),"Failed to render announcement user list."})},fail:function(e){l.error("local_announcements/list: unable to get announcemnt users."),l.debug(e)}}]))},a.prototype.deleteAnnouncement=function(e){var n=this,t=e.closest(".announcement"),o=t.find(".subject").first().html(),a=t.data("id");n.modals.DELETE&&(n.modals.DELETE.setBody('<p>Please confirm that you want to delete:<br><span style="font-style:italic;">'+o+"</span></p>"),n.modals.DELETE.getRoot().on(r.save,function(e){i.call([{methodname:"local_announcements_delete_announcement",args:{id:a},done:function(e){t.addClass("removing"),t.fadeOut(1e3,function(){s(this).remove()})},fail:function(e){l.error("local_announcements/list: unable to delete the announcement"),l.debug(e)}}])}),n.modals.DELETE.show())},a.prototype.loadModal=function(n,t,o,e){var a=this;return c.create({type:e}).then(function(e){e.setTitle(t),o&&e.setSaveButtonText(o),(a.modals[n]=e).getBackdrop(),e.getRoot().addClass("modal-"+n)})},a.prototype.loadTemplate=function(e){return o.render(this.templates[e],{})},{init:function(e){l.debug("local_announcements/list: initializing");var n=s(e).first();n.length?new a(n).main():l.error("local_announcements/list: "+e+" element not found!")}}});