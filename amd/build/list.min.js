define(["jquery","core/log","core/config","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events"],function(l,s,t,i,o,e,c,r){"use strict";function n(e){var n=this;n.rootel=e,n.modals={DELETE:null,VIEWUSERS:null,VIEWAS:null},n.templates={VIEWUSERS:"local_announcements/announcement_users_list"},n.ver="local_announcements_2019072200"}return n.prototype.main=function(){var t=this;t.rootel.on("click",".announcement .action-delete",function(e){e.preventDefault();var n=l(this);t.deleteAnnouncement(n)}),t.rootel.on("click",".announcement .action-viewusers",function(e){e.preventDefault();var n=l(this);t.viewAnnouncementUsers(n)}),t.rootel.on("click",".option-viewas",function(e){e.preventDefault(),t.viewAs()});var e=[];if(e.push(t.loadModal("DELETE","Delete Announcement","Delete",c.types.SAVE_CANCEL)),e.push(t.loadModal("VIEWUSERS","Announcement Recipients","",c.types.DEFAULT)),e.push(t.loadModal("VIEWAS","View as another user","Go",c.types.SAVE_CANCEL)),e.push(t.loadTemplate("VIEWUSERS")),l.when.apply(l,e).then(function(){t.rootel.addClass("preloads-completed")}),"undefined"!=typeof InfiniteScroll)new InfiniteScroll(".lann-list",{path:".next",append:".announcement",history:!1,status:".page-load-status"})},n.prototype.viewAs=function(){var e=this;e.modals.VIEWAS&&(e.modals.VIEWAS.setBody('<p>Enter the ID of a user:</p><p><input class="form-control" id="viewas-user" size="48"/></p>'),e.modals.VIEWAS.getRoot().on(r.save,function(e){var n=l("input#viewas-user").val();window.location.href=t.wwwroot+"/local/announcements/index.php?viewas="+n}),e.modals.VIEWAS.show())},n.prototype.viewAnnouncementUsers=function(e){var t=this,n=e.closest(".announcement").data("id");t.modals.VIEWUSERS&&(t.modals.VIEWUSERS.getModal().addClass("modal-xl"),t.modals.VIEWUSERS.setBody('<div style="font-style:italic;">... Fetching user list ...<div class="loader" style="display:block;"><div class="circle spin"></div></div></div>'),t.modals.VIEWUSERS.show(),i.call([{methodname:"local_announcements_get_announcement_users",args:{id:n},done:function(e){var n=Object.keys(e.userslist).length;t.modals.VIEWUSERS.setTitle("Audience Recipients ("+n+")"),o.render(t.templates.VIEWUSERS,e,t.ver).done(function(e){t.modals.VIEWUSERS.setBody(e)}).fail(function(e){return s.debug(e),"Failed to render announcement user list."})},fail:function(e){s.error("local_announcements/list: unable to get announcemnt users."),s.debug(e)}}]))},n.prototype.deleteAnnouncement=function(e){var n=this,t=e.closest(".announcement"),o=t.find(".subject").first().html(),a=t.data("id");n.modals.DELETE&&(n.modals.DELETE.setBody('<p>Please confirm that you want to delete:<br><span style="font-style:italic;">'+o+"</span></p>"),n.modals.DELETE.getRoot().on(r.save,function(e){i.call([{methodname:"local_announcements_delete_announcement",args:{id:a},done:function(e){t.addClass("removing"),t.fadeOut(1e3,function(){l(this).remove()})},fail:function(e){s.error("local_announcements/list: unable to delete the announcement"),s.debug(e)}}])}),n.modals.DELETE.show())},n.prototype.loadModal=function(n,t,o,e){var a=this;return c.create({type:e}).then(function(e){e.setTitle(t),o&&e.setSaveButtonText(o),(a.modals[n]=e).getBackdrop(),e.getRoot().addClass("modal-"+n)})},n.prototype.loadTemplate=function(e){return o.render(this.templates[e],{},this.ver)},{init:function(){s.debug("local_announcements/list: initializing");var e=l(".local_announcements").first();e.length?new n(e).main():s.error("local_announcements/list: .local_announcements element not found!")}}});