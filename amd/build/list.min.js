define(["jquery","core/log","core/config","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events"],function(a,s,t,i,o,e,c,u){"use strict";function l(e){var n=this;n.rootel=e,n.modals={DELETE:null,VIEWUSERS:null,VIEWAS:null},n.templates={VIEWUSERS:"local_announcements/announcement_users_list"}}return l.prototype.main=function(){var t=this;t.rootel.on("click",".announcement .action-delete",function(e){e.preventDefault();var n=a(this);t.deleteAnnouncement(n)}),t.rootel.on("click",".announcement .action-viewusers",function(e){e.preventDefault();var n=a(this);t.viewAnnouncementUsers(n)}),t.rootel.on("click",".option-viewas",function(e){e.preventDefault(),t.viewAs()}),t.rootel.on("click",".view-full-link",function(e){e.preventDefault();var n=a(this);t.getFullMessage(n)});var e=[];if(e.push(t.loadModal("DELETE","Delete Announcement","Delete",c.types.SAVE_CANCEL)),e.push(t.loadModal("VIEWUSERS","Announcement Recipients","",c.types.DEFAULT)),e.push(t.loadModal("VIEWAS","View as another user","Go",c.types.SAVE_CANCEL)),e.push(t.loadTemplate("VIEWUSERS")),a.when.apply(a,e).then(function(){t.rootel.addClass("preloads-completed")}),"undefined"!=typeof InfiniteScroll)new InfiniteScroll(".lann-list",{path:".next",append:".announcement",history:!1,status:".page-load-status"})},l.prototype.viewAs=function(){var e=this;e.modals.VIEWAS&&(e.modals.VIEWAS.setBody('<p>Enter the ID of a user:</p><p><input class="form-control" id="viewas-user" size="48"/></p>'),e.modals.VIEWAS.getRoot().on(u.save,function(e){var n=a("input#viewas-user").val();window.location.href=t.wwwroot+"/local/announcements/index.php?viewas="+n}),e.modals.VIEWAS.show())},l.prototype.viewAnnouncementUsers=function(e){var t=this,n=e.closest(".announcement").data("id");t.modals.VIEWUSERS&&(t.modals.VIEWUSERS.getModal().addClass("modal-xl"),t.modals.VIEWUSERS.setBody('<div style="font-style:italic;">... Fetching user list ...<div class="loader" style="display:block;"><div class="circle spin"></div></div></div>'),t.modals.VIEWUSERS.show(),i.call([{methodname:"local_announcements_get_announcement_users",args:{id:n},done:function(e){var n=Object.keys(e.userslist).length;t.modals.VIEWUSERS.setTitle("Audience Recipients ("+n+")"),o.render(t.templates.VIEWUSERS,e).done(function(e){t.modals.VIEWUSERS.setBody(e)}).fail(function(e){return s.debug(e),"Failed to render announcement user list."})},fail:function(e){s.error("local_announcements/list: unable to get announcemnt users."),s.debug(e)}}]))},l.prototype.deleteAnnouncement=function(e){var n=this,t=e.closest(".announcement"),o=t.find(".subject").first().html(),l=t.data("id");n.modals.DELETE&&(n.modals.DELETE.setBody('<p>Please confirm that you want to delete:<br><span style="font-style:italic;">'+o+"</span></p>"),n.modals.DELETE.getRoot().on(u.save,function(e){i.call([{methodname:"local_announcements_delete_announcement",args:{id:l},done:function(e){t.addClass("removing"),t.fadeOut(1e3,function(){a(this).remove()})},fail:function(e){s.error("local_announcements/list: unable to delete the announcement"),s.debug(e)}}])}),n.modals.DELETE.show())},l.prototype.getFullMessage=function(e){var n=e.closest(".announcement"),t=n.data("id");n.addClass("fetching-full"),i.call([{methodname:"local_announcements_get_full_message",args:{id:t},done:function(e){n.removeClass("fetching-full"),n.addClass("full-message"),n.find(".message").html(e.fullmessage)},fail:function(e){n.removeClass("fetching-full"),s.error("local_announcements/list: unable to get full message."),s.debug(e)}}])},l.prototype.loadModal=function(n,t,o,e){var l=this;return c.create({type:e}).then(function(e){e.setTitle(t),o&&e.setSaveButtonText(o),(l.modals[n]=e).getBackdrop(),e.getRoot().addClass("modal-"+n)})},l.prototype.loadTemplate=function(e){return o.render(this.templates[e],{})},{init:function(e){s.debug("local_announcements/list: initializing");var n=a(e).first();n.length?new l(n).main():s.error("local_announcements/list: "+e+" element not found!")}}});