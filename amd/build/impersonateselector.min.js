define(["jquery","core/log","core/ajax","core/templates","core/str"],function(r,s,t,a,n){"use strict";function o(e){var t=this;t.rootel=e,t.component="local_announcements",t.wildcard=!1,t.rootel.data("wildcard")&&(t.wildcard=!0),t.rootel.data("hasresults")&&(t.hasresults=!0),t.strings={},n.get_strings([{key:"postform:impersonatenoselection",component:t.component}]).then(function(e){t.strings.noselectionstr=e[0]})}return o.prototype.main=function(){var n,o=this;o.render(),o.rootel.on("keyup",".impersonate-autocomplete",function(e){clearTimeout(n);var t=r(this);o.wildcard?n=setTimeout(function(){o.search(t)},500):t.val("")}),o.rootel.on("click",".impersonate-result",function(e){e.preventDefault();var t=r(this);o.add(t)}),o.rootel.on("click",".impersonate-tag",function(e){e.preventDefault();var t=r(this);o.remove(t)}),o.rootel.on("focus",".impersonate-autocomplete",function(e){o.refocus()}),r(document).on("click",function(e){var t=r(e.target);t.is(".impersonate-autocomplete")||t.is(".impersonate-result")||o.unfocus()})},o.prototype.add=function(e){this.unfocus();var t=r('input[name="impersonate"]'),n={username:e.data("username"),photourl:e.find("img").attr("src"),fullname:e.find("span").text()};t.val(JSON.stringify(n)),this.render()},o.prototype.remove=function(e){r('input[name="impersonate"]').val(""),this.render()},o.prototype.render=function(){var t=this,e=r('input[name="impersonate"]');if(""!=e.val()){var n=e.val();if(n){var o=JSON.parse(n);console.log(o),a.render("local_announcements/impersonate_selector_tag",o).then(function(e){t.rootel.find(".impersonate-selection").html(e)}).fail(function(e){s.error(e)})}}else t.rootel.find(".impersonate-selection").html(t.strings.noselectionstr)},o.prototype.search=function(e){var n=this;n.hasresults=!1,""!=e.val()&&t.call([{methodname:"local_announcements_get_impersonate_users",args:{query:e.val()},done:function(e){e.length?(n.hasresults=!0,a.render("local_announcements/impersonate_selector_results",{users:e}).then(function(e){var t=n.rootel.find(".impersonate-results");t.html(e),t.addClass("active")}).fail(function(e){s.error(e)})):n.rootel.find(".impersonate-results").removeClass("active")},fail:function(e){s.error("local_announcements/impersonateselector: failed to search."),s.debug(e)}}])},o.prototype.unfocus=function(){this.rootel.find(".impersonate-results").removeClass("active")},o.prototype.refocus=function(){this.hasresults&&this.rootel.find(".impersonate-results").addClass("active")},{init:function(){s.debug("local_announcements/impersonateselector: initializing the impersonate-selector component");var e=r(".impersonate-selector").first();e.length?new o(e).main():s.error("local_announcements/impersonateselector: impersonate-selector root element not found!")}}});