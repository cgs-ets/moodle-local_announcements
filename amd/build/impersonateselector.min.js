define(["jquery","core/log","core/ajax","core/templates","core/str"],function(r,n,t,a,o){"use strict";function s(e){var t=this;t.rootel=e,t.component="local_announcements",t.wildcard=!1,t.rootel.data("wildcard")&&(t.wildcard=!0),t.rootel.data("hasresults")&&(t.hasresults=!0),t.strings={},o.get_strings([{key:"postform:impersonatenoselection",component:t.component}]).then(function(e){t.strings.noselectionstr=e[0]})}return s.prototype.main=function(){var o,n=this;n.render(),n.rootel.on("keyup",".impersonate-autocomplete",function(e){clearTimeout(o);var t=r(this);n.wildcard?o=setTimeout(function(){n.search(t)},500):t.val("")}),n.rootel.on("click",".impersonate-result",function(e){e.preventDefault();var t=r(this);n.add(t)}),n.rootel.on("click",".impersonate-tag",function(e){e.preventDefault();var t=r(this);n.remove(t)}),n.rootel.on("focus",".impersonate-autocomplete",function(e){n.refocus()}),r(document).on("click",function(e){var t=r(e.target);t.is(".impersonate-autocomplete")||t.is(".impersonate-result")||n.unfocus()})},s.prototype.add=function(e){var t=this;t.unfocus(),r('input[name="impersonate"]').val(e.data("username")),t.rootel.data("photo",e.find("img").attr("src")),t.rootel.data("fullname",e.find("span").text()),t.render()},s.prototype.remove=function(e){var t=this;r('input[name="impersonate"]').val(""),t.rootel.data("photo",""),t.rootel.data("photo",""),t.render()},s.prototype.render=function(){var t=this,e=r('input[name="impersonate"]');if(""!=e.val()){var o={username:e.val(),photo:t.rootel.data("photo"),fullname:t.rootel.data("fullname")};a.render("local_announcements/impersonate_selector_tag",o).then(function(e){t.rootel.find(".impersonate-tags").html(e)}).fail(function(e){n.error(e)})}else t.rootel.find(".impersonate-tags").html(t.strings.noselectionstr)},s.prototype.search=function(e){var o=this;o.hasresults=!1,""!=e.val()&&t.call([{methodname:"local_announcements_get_impersonate_users",args:{query:e.val()},done:function(e){e.length?(o.hasresults=!0,a.render("local_announcements/impersonate_selector_results",{users:e}).then(function(e){var t=o.rootel.find(".impersonate-results");t.html(e),t.addClass("active")}).fail(function(e){n.error(e)})):o.rootel.find(".impersonate-results").removeClass("active")},fail:function(e){n.error("local_announcements/impersonateselector: failed to search."),n.debug(e)}}])},s.prototype.unfocus=function(){this.rootel.find(".impersonate-results").removeClass("active")},s.prototype.refocus=function(){this.hasresults&&this.rootel.find(".impersonate-results").addClass("active")},{init:function(){n.debug("local_announcements/impersonateselector: initializing the impersonate-selector component");var e=r(".impersonate-selector").first();e.length?new s(e).main():n.error("local_announcements/impersonateselector: impersonate-selector root element not found!")}}});