{"version":3,"sources":["../src/list.js"],"names":["define","$","Log","Config","Ajax","Templates","Str","ModalFactory","ModalEvents","List","rootel","self","modals","DELETE","VIEWUSERS","VIEWAS","templates","ver","prototype","main","on","e","preventDefault","button","deleteAnnouncement","viewAnnouncementUsers","viewAs","preloads","loadModal","types","SAVE_CANCEL","DEFAULT","loadTemplate","when","apply","then","addClass","InfiniteScroll","path","append","history","status","setBody","getRoot","save","viewas","val","window","location","href","wwwroot","show","announcement","closest","id","data","getModal","call","methodname","args","done","response","count","Object","keys","length","setTitle","render","html","fail","reason","debug","error","subject","find","first","fadeOut","remove","modalkey","title","buttontext","type","create","modal","setSaveButtonText","getBackdrop","templatekey","init","list"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides the local_announcements/list module\n *\n * @package   local_announcements\n * @category  output\n * @copyright 2020 Michael Vangelovski <michael.vangelovski@hotmail.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_announcements/list\n */\ndefine(['jquery', 'core/log', 'core/config', 'core/ajax','core/templates', \n        'core/str', 'core/modal_factory', 'core/modal_events' ], \n        function($, Log, Config, Ajax, Templates, Str, ModalFactory, ModalEvents) {    \n    'use strict';\n\n    /**\n     * Initializes the list component.\n     */\n    function init() {\n        Log.debug('local_announcements/list: initializing');\n\n        var rootel = $('.local_announcements').first();\n\n        if (!rootel.length) {\n            Log.error('local_announcements/list: .local_announcements element not found!');\n            return;\n        }\n\n        var list = new List(rootel);\n        list.main();\n    }\n\n\n    /**\n     * The constructor\n     *\n     * @constructor\n     * @param {jQuery} rootel\n     */\n    function List(rootel) {\n        var self = this;\n        self.rootel = rootel;\n\n        self.modals = {\n            DELETE: null,\n            VIEWUSERS: null,\n            VIEWAS: null,\n        };\n        self.templates = {\n            VIEWUSERS: 'local_announcements/announcement_users_list',\n        };\n\n        //versioned name to force refetch templates after updates and prevent them being pulled from browser cache. \n        self.ver = 'local_announcements_2019072200';\n    }\n\n\n    /**\n     * Run the Audience Selector.\n     *\n     */\n   List.prototype.main = function () {\n        var self = this;\n\n        // Handle delete announcement button click.\n        self.rootel.on('click', '.announcement .action-delete', function(e) {\n            e.preventDefault();\n            var button = $(this);\n            self.deleteAnnouncement(button);\n        });\n\n        // Handle view users button click.\n        self.rootel.on('click', '.announcement .action-viewusers', function(e) {\n            e.preventDefault();\n            var button = $(this);\n            self.viewAnnouncementUsers(button);\n        });\n\n        // Handle view as button click.\n        self.rootel.on('click', '.option-viewas', function(e) {\n            e.preventDefault();\n            self.viewAs();\n        });\n\n        // Preload the modals and templates.\n        var preloads = [];\n        preloads.push(self.loadModal('DELETE', 'Delete Announcement', 'Delete', ModalFactory.types.SAVE_CANCEL));\n        preloads.push(self.loadModal('VIEWUSERS', 'Announcement Recipients', '', ModalFactory.types.DEFAULT));\n        preloads.push(self.loadModal('VIEWAS', 'View as another user', 'Go', ModalFactory.types.SAVE_CANCEL));\n        preloads.push(self.loadTemplate('VIEWUSERS'));\n        // Do not show actions until all modals and templates are preloaded.\n        $.when.apply($, preloads).then(function() {\n            self.rootel.addClass('preloads-completed');\n        })\n\n        // set up infinite scroll\n        if(typeof InfiniteScroll != 'undefined') {\n          var infScroll = new InfiniteScroll( '.lann-list', {\n            // options\n            path: '.next',\n            append: '.announcement',\n            history: false,\n            status: '.page-load-status',\n          });\n        }\n\n    };\n\n    /**\n     * View a list of users for an announcement\n     *\n     * @method\n     */\n    List.prototype.viewAs = function () {\n        var self = this;\n\n        if (self.modals.VIEWAS) {\n            self.modals.VIEWAS.setBody('<p>Enter the ID of a user:</p><p><input class=\"form-control\" id=\"viewas-user\" size=\"48\"/></p>');\n            self.modals.VIEWAS.getRoot().on(ModalEvents.save, function(e) {\n              var viewas = $('input#viewas-user').val();\n              window.location.href = Config.wwwroot + \"/local/announcements/index.php?viewas=\" + viewas;\n            });\n            self.modals.VIEWAS.show();\n        }\n    };\n\n    /**\n     * View a list of users for an announcement\n     *\n     * @method\n     */\n    List.prototype.viewAnnouncementUsers = function (button) {\n        var self = this;\n\n        var announcement = button.closest('.announcement');\n        var id = announcement.data('id');\n\n        if (self.modals.VIEWUSERS) {\n            self.modals.VIEWUSERS.getModal().addClass('modal-xl');\n            self.modals.VIEWUSERS.setBody('<div style=\"font-style:italic;\">... Fetching user list ...<div class=\"loader\" style=\"display:block;\"><div class=\"circle spin\"></div></div></div>');\n            self.modals.VIEWUSERS.show();\n            Ajax.call([{\n                methodname: 'local_announcements_get_announcement_users',\n                args: { id: id },\n                done: function(response) {\n                    var count = Object.keys(response['userslist']).length;\n                    self.modals.VIEWUSERS.setTitle('Audience Recipients (' + count + ')');\n                    Templates.render(self.templates.VIEWUSERS, response, self.ver)\n                        .done(function(html) {\n                            self.modals.VIEWUSERS.setBody(html);\n                        })\n                        .fail(function(reason) {\n                            Log.debug(reason);\n                            return \"Failed to render announcement user list.\"\n                        });\n                },\n                fail: function(reason) {\n                    Log.error('local_announcements/list: unable to get announcemnt users.');\n                    Log.debug(reason);\n                }\n            }]);\n        }\n    };\n\n    /**\n     * Delete an announcement.\n     *\n     * @method\n     */\n    List.prototype.deleteAnnouncement = function (button) {\n        var self = this;\n\n        var announcement = button.closest('.announcement');\n        var subject = announcement.find('.subject').first().html();\n        var id = announcement.data('id');\n\n        if (self.modals.DELETE) {\n            self.modals.DELETE.setBody('<p>Please confirm that you want to delete:<br><span style=\"font-style:italic;\">' + subject + '</span></p>');\n            self.modals.DELETE.getRoot().on(ModalEvents.save, function(e) {\n                Ajax.call([{\n                    methodname: 'local_announcements_delete_announcement',\n                    args: { id: id },\n                    done: function(response) {\n                        announcement.addClass('removing');\n                        announcement.fadeOut(1000, function() {\n                            $(this).remove();\n                        });\n                    },\n                    fail: function(reason) {\n                        Log.error('local_announcements/list: unable to delete the announcement');\n                        Log.debug(reason);\n                    }\n                }]);\n            });\n            self.modals.DELETE.show();\n        }\n    };\n\n    /**\n     * Helper used to preload a modal\n     *\n     * @method loadModal\n     * @param {string} modalkey The property of the global modals variable\n     * @param {string} title The title of the modal\n     * @param {string} title The button text of the modal\n     * @return {object} jQuery promise\n     */\n    List.prototype.loadModal = function (modalkey, title, buttontext, type) {\n        var self = this;\n        return ModalFactory.create({type: type}).then(function(modal) {\n            modal.setTitle(title);\n            if (buttontext) {\n                modal.setSaveButtonText(buttontext);\n            }\n            self.modals[modalkey] = modal;\n            // Preload backgrop.\n            modal.getBackdrop();\n            modal.getRoot().addClass('modal-' + modalkey);\n        });\n    }\n\n    /**\n     * Helper used to preload a template\n     *\n     * @method loadModal\n     * @param {string} templatekey The property of the global templates variable\n     * @return {object} jQuery promise\n     */\n    List.prototype.loadTemplate = function (templatekey) {\n        var self = this;\n        return Templates.render(self.templates[templatekey], {}, self.ver);\n    }\n\n    return {\n        init: init\n    };\n});"],"file":"list.min.js"}